
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>SchoolInfo</title>
    <!--框架必需start-->
    <script type="text/javascript" src="~/quickui/libs/js/jquery.js"></script>
    <script type="text/javascript" src="~/quickui/libs/js/language/cn.js"></script>
    <script type="text/javascript" src="~/quickui/libs/js/framework.js"></script>
    <link href="~/quickui/libs/css/import_basic.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" id="skin" prePath="~/quickui/" />
    <link rel="stylesheet" type="text/css" id="customSkin" />
    <!--框架必需end-->
    <link rel="stylesheet" type="text/css" href="~/quickui/style/style.css" />
    <script src="~/quickui/libs/js/table/quiGrid.js" type="text/javascript"></script>
    <!--引入提示组件start-->
    <script type="text/javascript" src="/quickui/libs/js/popup/toast.js"></script>
    <script type="text/javascript" src="/quickui/libs/js/popup/notice.js"></script>
    <!--引入提示组件end-->
    <!--树组件start -->
    <script type="text/javascript" src="/quickui/libs/js/tree/ztree/ztree.js"></script>
    <link href="/quickui/libs/js/tree/ztree/ztree.css" rel="stylesheet" type="text/css" />
    <!--树组件end -->
    <!--布局控件start-->
    <script type="text/javascript" src="/quickui/libs/js/nav/layout.js"></script>
    <!--布局控件end-->
</head>
<body>

    <div id="layout1">
        <div position="center" style="" panelTitle="组织架构">
            <div id="orgContent" style="overflow-y:auto;">
                <ul id="tree-1" class="ztree"></ul>
            </div>
        </div>
        <div position="right" style="" panelTitle="单位详情">
            <div class="buttonGroup clearfloat">
                <div class="popupMenu">
                    <span class="centerButton icon_add">新增</span>
                    <div class="clear"></div>
                    <div class="popupMenu_con">
                        <a href="javascript:addNew('school');"><span>校区</span></a>
                        <a href="javascript:addNew('lib');"><span>图书馆</span></a>
                        <a href="javascript:addNew('room');"><span>阅览室</span></a>
                    </div>
                </div>
            </div>
            <div style="padding-left:5px;" id="divSchoolForm">
                <table>
                    <tr>
                        <td>校区编号：</td>
                        <td>
                            <input type="text" style="width:300px;" id="schoolId" name="schoolId" readonly="readonly" />
                        </td>
                    </tr>
                    <tr>
                        <td>校区名字：</td>
                        <td><input type="text" style="width:300px;" id="schoolName" name="schoolName" /></td>
                    </tr>
                </table>
                <button type="button" onclick="addNew('school')" class="primary">保存</button>
            </div>
            <div style="padding-left:5px;" id="divLibForm">
                <table>
                    <tr>
                        <td>图书馆编号：</td>
                        <td>
                            <input type="text" style="width:300px;" id="libId" name="libId" readonly="readonly" />
                        </td>
                    </tr>
                    <tr>
                        <td>图书馆名字：</td>
                        <td><input type="text" style="width:300px;" id="libName" name="libName" /></td>
                    </tr>
                    <tr>
                        <td>所属校区：</td>
                        <td>
                          <select id="selectSchool" name="selectSchool" >
                          </select>
                        </td>
                    </tr>
                </table>
                <button type="button" onclick="addNew('lib')" class="primary">保存</button>
            </div>
            <div style="padding-left:5px;" id="divRoomForm">
                <table>
                    <tr>
                        <td>阅览室编号：</td>
                        <td>
                            <input type="text" style="width:300px;" id="roomId" name="roomId" readonly="readonly" />
                        </td>
                    </tr>
                    <tr>
                        <td>阅览室名字：</td>
                        <td><input type="text" style="width:300px;" id="roomName" name="roomName" /></td>
                    </tr>
                    <tr>
                        <td>所属图书馆：</td>
                        <td>
                            <select id="selectLib" name="selectLib" url="/SchoolInfoManage/GetSelectLib">
                            </select>
                        </td>
                    </tr>
                </table>
                <button type="button" onclick="addNew('room')" class="primary">保存</button>
                <input type="button" onclick="roomSetting()" value="阅览室设置" class="success" />
            </div>
           
        </div>
    </div>
    <div id="pb1"></div><span id="pb1-label"></span>


    <script>
        var setting1 = {
            view: {
                //addHoverDom: addHoverDom,
                //removeHoverDom: removeHoverDom,
                selectedMulti: false
            },
            edit: {
                enable: true,
                renameTitle:"修改",
                removeTitle:"删除"
            },
            callback: {
                onClick: onClick1
                ////不允许拖拽
                //beforeDrag: beforeDrag1,
                ////修改前确认
                //beforeEditName: beforeEditName1,
                ////修改完时的处理
                //beforeRename: beforeRename1,
                ////修改成功后处理
                //onRename: onRename1,
                ////删除前确认
                //beforeRemove: beforeRemove1
            }};

        var zNodes1 = "";

       
        //初始化函数
        function initComplete() {
            var layout = $("#layout1").layout({ rightWidth: 1100 });
            //layout.setRightCollapse(true);

            //初始化树
            getOrgTreeData();

            $("#divSchoolForm").hide();
            $("#divLibForm").hide();
            $("#divRoomForm").hide();
        }

        //获取数据初始化树
        function getOrgTreeData() {
            //var _progress;
            //_progress = $("#pb1").progressCtrl({ skin: '/quickui/libs/images/loading/progress.png', width: 300 });
            //setTimeout(function () { _progress.progressCtrl(50); }, 300);
            $.ajax({
                type: 'POST',
                url: '/SchoolInfoManage/GetTreeData',
                data: null,
                success: function (result) {
                    var obj = eval('(' + result + ')');
                    zNodes1 = obj;
                    $.fn.zTree.init($("#tree-1"), setting1, zNodes1);
                },
                error: function (a) {
                    top.Toast("showErrorToast", "访问服务器端出错！");
                },
                dataType: 'text'
            });
        }

        //获取树对象
        function getTree() {
            return $.fn.zTree.getZTreeObj("tree-1");
        }

        //点击树节点
        function onClick1(event, treeId, treeNode, clickFlag) {

            var schoolId = "";
            var schoolName = "";
            var libId = "";
            var libName = "";
            var roomId = "";
            var roomName = "";

            if (treeNode.tName == "school")
            {
                schoolId = treeNode.id;
                schoolName = treeNode.name;
            }
            else if (treeNode.tName == "lib")
            {
                libId = treeNode.id;
                libName = treeNode.name;
            }
            else if (treeNode.tName == "room")
            {
                roomId = treeNode.id;
                roomName = treeNode.name;
            }
            setForm(treeNode.tName, treeNode.parentId, schoolId, schoolName, libId, libName, roomId, roomName);
        }

        //设置表单值
        function setForm(tName, parentId, schoolId, schoolName, libId, libName, roomId, roomName)
        {
            if (tName == "school") {
                $("#divSchoolForm").show();
                $("#divLibForm").hide();
                $("#divRoomForm").hide();

                $("#schoolId").val(schoolId);
                $("#schoolName").val(schoolName);

            } else if (tName == "lib") {
                $("#divSchoolForm").hide();
                $("#divLibForm").show();
                $("#divRoomForm").hide();

                $("#libId").val(libId);
                $("#libName").val(libName);

                $.ajax({
                    type: 'POST',
                    url: '/SchoolInfoManage/GetSelectSchool',
                    data: null,
                    success: function (result) {
                        var obj = eval('(' + result + ')');
                        $("#selectSchool").data("data", obj)
                        $("#selectSchool").render();
                        $("#selectSchool").setValue(parentId);
                    },
                    error: function (a) {
                        top.Toast("showErrorToast", "访问服务器端出错！");
                    },
                    dataType: 'text'
                });

            } else if (tName == "room") {
                $("#divSchoolForm").hide();
                $("#divLibForm").hide();
                $("#divRoomForm").show();

                $("#roomId").val(roomId);
                $("#roomName").val(roomName);

                $.ajax({
                    type: 'POST',
                    url: '/SchoolInfoManage/GetSelectLib',
                    data: null,
                    success: function (result) {
                        var obj = eval('(' + result + ')');
                        $("#selectLib").data("data", obj)
                        $("#selectLib").render();
                        $("#selectLib").setValue(parentId);
                    },
                    error: function (a) {
                        top.Toast("showErrorToast", "访问服务器端出错！");
                    },
                    dataType: 'text'
                });
            }
        }

        function addNew(arg) {
            var title = "";

            if (arg == "school") title = "新增校区";
            if (arg == "lib") title = "新增图书馆";
            if (arg == "room") title = "新增阅览室";

            var diag = new top.Dialog();
            diag.Title = title;
            diag.URL = "/SchoolInfoManage/AddNew?arg="+arg;
            diag.Width = 500;
            diag.Height = 250;
            diag.OkButtonText = "保 存";
            //顺序很重要，diag.show()之前添加确定按钮事件，show之后添加新按钮
            diag.OKEvent = function () {
                var inputValue = diag.innerFrame.contentWindow.myTest();
            };
            diag.show();

        }

        function roomSetting() {
            // var selectData = grid.getSelectedRow();
            selectNo = $("#roomId").val();
            if (selectNo == null) {
                top.Toast('showErrorToast', '请选中要设置的阅览室');
            } else {
                var diag = new top.Dialog();
                diag.Title = "[" + selectNo + "]阅览室设置";
                diag.URL = "/SchoolInfoManage/ReadingRoomSetting?id=" + selectNo;
                diag.Width = 1200;
                diag.Height = 800;
                diag.OkButtonText = "保 存";
                //顺序很重要，diag.show()之前添加确定按钮事件，show之后添加新按钮
                diag.OKEvent = function () {
                    var inputValue = diag.innerFrame.contentWindow.myTest();
                };
                diag.show();
            }
        }

    </script>
    
</body>
</html>
